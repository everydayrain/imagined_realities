---
author: Chris
title: Graylog on Proxmox and Ansible for Client Config
date: 2025-01-24
tags:
  - proxmox
---

### Summary

This is a bit of an hodgepodge post offering a few pieces of advice and a rough model of Ansible code for Rsyslog instead of a step-by-step guide. This post assumes the reader has foreknowledge of Grayhound as a tool, and a desire to install it using conventional package managers. It moreover assumes the reader is comfortable enough with the Linux command line to install and with Ansible roles and execution.

### Introduction

In this post I'm not going to detail the individual steps of installing Graylog on a Proxmox VM. I found that [the official docs ](https://go2docs.graylog.org/current/home.htm) are sufficient, even if the overall documentation is hard to navigate. Moreover, it'd make this post too long to include all the steps for installing the MongoDB instance, the Graylog Node and then Graylog itself in addition to the pitfalls and Ansible code I'm outlining here. So I suggest reviewing [the official docs ](https://go2docs.graylog.org/current/home.htm) in tandem with this post.

Instead, I'm going to cover two notes on how to make an install of Graylog on a Proxmox VM go more smoothly. If I'd known about these challenges ahead of time I could have saved myself a little pain. For a bonus, I'm including my Ansible plays to configure rsyslog for client log forwarding to Graylog.

One note of warning: be prepared for Graylog's RAM consumption. Graylog is a RAM hog. You'll see your ram usage shoot up so it'd pay to go into this project with your eyes open.

### Details of the VM Config

I went with a VM because Graylog is a bit of a beast, requiring multiple different components and lots of RAM. I believe people have installed it on LXC containers, but I figured I'd run into fewer problems this way. Well, at least fewer problems than I would otherwise. Not absent problems.

The **first** issue was relatively trivial but time consuming to figure out. I figured I'd put Graylog on the latest Ubuntu LTS (24.04). It took a full install cycle using the [Ubuntu Debian-Installer](https://wiki.ubuntu.com/Installer/FAQ) and troubleshooting to realize that MongoDB wouldn't play nice with that version. MongoDB is required for Graylog's function so this wasn't something I could figure out later. Lesson learned. As of this writing, I used 22.04.

The **second** was that MongoDB[ doesn't play nice with Proxmox's defaults](https://forum.proxmox.com/threads/mongo-db-5-0-not-install.95857/post-440005). I had learned and subsequently forgotten this one from a previous encounter with MongoDB. In particular, I had to tweak an option that I otherwise never change regarding the processor, as MongoDB cannot work on the default selection of x86-64-v2-AES. In the VM creation guide, on the CPU tab, for "Type," I had to set the processor to _host_ in order for it to function correctly in the VM.
{% imagesmall '/img/2025-01-21_11-41.png', '' %}

### Onward to the Logdom

From there I followed [the official docs ](https://go2docs.graylog.org/current/downloading_and_installing_graylog/ubuntu_installation.htm#aanchor21) for an Ubuntu install without problems.

### Automating Client Rsyslog Configurations with Ansible

Take what follows as a rough model rather than specific directions.

Next, there was the matter of configuring my machines [to send logs to Graylog](https://go2docs.graylog.org/current/getting_in_log_data/syslog_inputs.html). Graylog offers a [variety of different ways](https://go2docs.graylog.org/current/getting_in_log_data/inputs.htm) to accept logs from client machines. I went with Rsyslog.

Now, I could have ssh-ed into each individual machine and altered the `/etc/rsyslog.conf` file by hand to include:

```b
*.*@@yourgraylog.example.org:514;RSYSLOG_SyslogProtocol23Format
```

However, from the start this task seemed ripe for automation.

I built an Ansible script to ensure rsyslog was installed and then to configure it on the clients. I'd been playing around with Ansible over the weekend, and the YAML format is great compared to writing everything out in pure python.

Be aware, while the Ansible code can be found below, there are a bunch of configuration challenges to Ansible that can sidetrack you for hours. I can think of at least two off the top of my head. First, I used the code below as an [Ansible Role](https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_reuse_roles.html). Covering what that means, and how to setup Ansible, is far beyond the scope of this article. If you're new to it, plan some free hours to start toying around. Start with [the docs](https://docs.ansible.com/ansible/latest/getting_started/index.html); they're just average but they're worth it for just getting started. Second, if you use _sudo_ with a password on the target, you'll want to use Ansible-Vault. However, the whole way Ansible Vault works is super unclear to me. I hope to write up a blog post about it sometime. I'm afraid I don't have a confirmed solution for it as of this writing. Also, I can't help if you are thinking of windows hosts, I don't have windows clients.

Because this is a role _main.yml_ file, it may seem truncated. To explain, the first section determines whether rsyslog is installed. The second determines whether the Graylog code for forwarding the logs is already present in the `/etc/rsyslog.conf` file, and if not, adds it to the final line. The final section then restarts the rsyslog server.

```yml
- name: Install rsyslog
  ansible.builtin.apt:
    name: rsyslog

- name: Add instruction to dispatch logs to graylog
  ansible.builtin.lineinfile:
    path: /etc/rsyslog.conf
    line: "*.*@@YOUR_IP_HERE;RSYSLOG_SyslogProtocol23Format"
    regexp: '\*.\*@@YOUR_IP_HERE;RSYSLOG_SyslogProtocol23Format'
    state: present
    insertafter: EOF
    create: true

- name: Restart rsyslog
  ansible.builtin.shell:
    cmd: systemctl restart rsyslog
```

You'd then run that using Ansible as a role in your playbook.

### Conclusion

Admittedly, this is a post with a niche attraction, but nevertheless I hope it may help someone in the future. Should you have any questions, don't hesitate to DM me on [Mastodon](https://infosec.exchange/@anthro_packets).
